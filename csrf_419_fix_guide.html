<!DOCTYPE html>
<html>
<head>
    <title>üîß R√©solution Erreur 419 - Page Expired</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
        .warning { color: #ffc107; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .fix-box { background-color: #d4edda; padding: 15px; border-left: 4px solid #28a745; margin: 10px 0; }
        .problem-box { background-color: #f8d7da; padding: 15px; border-left: 4px solid #dc3545; margin: 10px 0; }
        .code-block { background-color: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; margin: 10px 0; }
        .btn { display: inline-block; padding: 10px 20px; margin: 5px; text-decoration: none; border-radius: 5px; color: white; }
        .btn-primary { background-color: #007bff; }
        .btn-success { background-color: #28a745; }
        .btn-warning { background-color: #ffc107; color: #212529; }
        .btn-danger { background-color: #dc3545; }
        .step-list { list-style-type: none; padding: 0; counter-reset: step-counter; }
        .step-list li { padding: 8px 0; counter-increment: step-counter; }
        .step-list li:before { content: counter(step-counter) ". "; color: #007bff; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß R√©solution Erreur 419 - Page Expired</h1>
        
        <div class="test-section">
            <h2>‚ùå Erreur 419 - Page Expired</h2>
            <div class="problem-box">
                <h4>Qu'est-ce que l'erreur 419 ?</h4>
                <p>L'erreur 419 "Page Expired" se produit quand le token CSRF (Cross-Site Request Forgery) de Laravel a expir√© ou est invalide.</p>
                
                <h5>Causes Principales :</h5>
                <ul>
                    <li>‚ùå <strong>Session expir√©e :</strong> Vous √™tes rest√© inactif trop longtemps</li>
                    <li>‚ùå <strong>Cache navigateur :</strong> Formulaire mis en cache avec ancien token</li>
                    <li>‚ùå <strong>Configuration session :</strong> Dur√©e de vie trop courte</li>
                    <li>‚ùå <strong>Token CSRF manquant :</strong> @csrf absent du formulaire</li>
                </ul>
            </div>
        </div>
        
        <div class="test-section">
            <h2>‚úÖ Solutions Imm√©diates</h2>
            
            <div class="fix-box">
                <h4>üîÑ Solution 1 - Actualiser la Page</h4>
                <ol class="step-list">
                    <li><strong>Appuyez sur F5</strong> ou Ctrl+F5 pour actualiser</li>
                    <li><strong>Ou fermez et rouvrez</strong> l'onglet</li>
                    <li><strong>Retournez au formulaire</strong> et r√©essayez</li>
                </ol>
                <p class="success">‚úÖ Solution la plus simple et efficace dans 80% des cas</p>
            </div>
            
            <div class="fix-box">
                <h4>üóëÔ∏è Solution 2 - Vider le Cache du Navigateur</h4>
                <ol class="step-list">
                    <li><strong>Appuyez sur Ctrl+Shift+Delete</strong></li>
                    <li><strong>S√©lectionnez :</strong> "Images et fichiers en cache"</li>
                    <li><strong>Cliquez :</strong> "Effacer les donn√©es"</li>
                    <li><strong>Actualisez la page</strong></li>
                </ol>
                <p class="info">üí° R√©sout les probl√®mes de cache de formulaires</p>
            </div>
            
            <div class="fix-box">
                <h4>üîê Solution 3 - Reconnexion</h4>
                <ol class="step-list">
                    <li><strong>D√©connectez-vous</strong> de l'application</li>
                    <li><strong>Reconnectez-vous</strong> avec vos identifiants</li>
                    <li><strong>Retournez au formulaire</strong></li>
                </ol>
                <p class="info">üí° G√©n√®re une nouvelle session et un nouveau token CSRF</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîß Corrections Appliqu√©es</h2>
            
            <div class="fix-box">
                <h4>‚úÖ Augmentation de la Dur√©e de Vie des Sessions</h4>
                <p><strong>Fichier modifi√© :</strong> <code>config/session.php</code></p>
                
                <div class="code-block">
// AVANT (2 heures)
'lifetime' => (int) env('SESSION_LIFETIME', 120),

// APR√àS (8 heures)
'lifetime' => (int) env('SESSION_LIFETIME', 480),
                </div>
                
                <p class="success">‚úÖ Les sessions durent maintenant 8 heures au lieu de 2</p>
            </div>
            
            <div class="fix-box">
                <h4>‚úÖ Route de Diagnostic Ajout√©e</h4>
                <p><strong>Route cr√©√©e :</strong> <code>/test-csrf</code></p>
                
                <div class="code-block">
Route::get('/test-csrf', function() {
    return response()->json([
        'csrf_token' => csrf_token(),
        'session_id' => session()->getId(),
        'session_lifetime' => config('session.lifetime'),
        'session_driver' => config('session.driver'),
        'app_key_set' => !empty(config('app.key')),
        'current_time' => now(),
        'message' => 'Test CSRF et session'
    ]);
});
                </div>
                
                <p class="info">üí° Permet de diagnostiquer les probl√®mes de session et CSRF</p>
            </div>
            
            <div class="fix-box">
                <h4>‚úÖ V√©rification des Tokens CSRF</h4>
                <p>Tous les formulaires contiennent bien le token CSRF :</p>
                
                <div class="code-block">
‚úÖ Formulaire cr√©ation activit√© : @csrf pr√©sent
‚úÖ Formulaire modification activit√© : @csrf pr√©sent  
‚úÖ Formulaire suppression activit√© : @csrf pr√©sent
‚úÖ Formulaire cr√©ation sous-activit√© : @csrf pr√©sent
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üß™ Tests de Diagnostic</h2>
            
            <h3>Test 1 - V√©rifier le Token CSRF :</h3>
            <ol class="step-list">
                <li><strong>Acc√©dez √† :</strong> <code>/test-csrf</code></li>
                <li><strong>V√©rifiez :</strong> Pr√©sence du csrf_token</li>
                <li><strong>Notez :</strong> L'ID de session</li>
                <li><strong>Confirmez :</strong> session_lifetime = 480 minutes</li>
            </ol>
            
            <h3>Test 2 - Tester un Formulaire :</h3>
            <ol class="step-list">
                <li><strong>Ouvrez :</strong> Le formulaire de cr√©ation d'activit√©</li>
                <li><strong>Inspectez :</strong> F12 ‚Üí Elements</li>
                <li><strong>Cherchez :</strong> <code>&lt;input name="_token"&gt;</code></li>
                <li><strong>V√©rifiez :</strong> Que la valeur n'est pas vide</li>
            </ol>
            
            <h3>Test 3 - Console Navigateur :</h3>
            <div class="code-block">
// Dans la console du navigateur (F12)
console.log('CSRF Token:', document.querySelector('meta[name="csrf-token"]')?.content);
console.log('Form Token:', document.querySelector('input[name="_token"]')?.value);
            </div>
        </div>
        
        <div class="test-section">
            <h2>‚öôÔ∏è Configuration Avanc√©e</h2>
            
            <h3>Variables d'Environnement (.env) :</h3>
            <div class="code-block">
# Dur√©e de vie des sessions (en minutes)
SESSION_LIFETIME=480

# Driver de session
SESSION_DRIVER=file

# Chiffrement des sessions
SESSION_ENCRYPT=false

# Expiration √† la fermeture du navigateur
SESSION_EXPIRE_ON_CLOSE=false
            </div>
            
            <h3>Commandes Laravel Utiles :</h3>
            <div class="code-block">
# Vider le cache de l'application
php artisan cache:clear

# Vider le cache de configuration
php artisan config:clear

# Vider le cache des sessions
php artisan session:clear

# R√©g√©n√©rer la cl√© d'application
php artisan key:generate
            </div>
        </div>
        
        <div class="test-section">
            <h2>üö® Pr√©vention Future</h2>
            
            <h3>Bonnes Pratiques :</h3>
            <ul>
                <li>‚úÖ <strong>Sauvegardez r√©guli√®rement :</strong> √âvitez de perdre votre travail</li>
                <li>‚úÖ <strong>Actualisez avant soumission :</strong> Si vous √™tes rest√© inactif</li>
                <li>‚úÖ <strong>Utilisez plusieurs onglets :</strong> Pour √©viter les timeouts</li>
                <li>‚úÖ <strong>V√©rifiez la connexion :</strong> Avant de soumettre des formulaires longs</li>
            </ul>
            
            <h3>Surveillance :</h3>
            <div class="code-block">
# Surveiller les erreurs 419 dans les logs
tail -f storage/logs/laravel.log | grep "419"

# V√©rifier les sessions actives
ls -la storage/framework/sessions/

# Surveiller l'utilisation m√©moire des sessions
du -sh storage/framework/sessions/
            </div>
        </div>
        
        <div class="test-section">
            <h2>üîç Diagnostic Approfondi</h2>
            
            <h3>Si le Probl√®me Persiste :</h3>
            
            <h4>1. V√©rifier les Permissions :</h4>
            <div class="code-block">
# Permissions du dossier sessions
chmod 755 storage/framework/sessions/
chmod 644 storage/framework/sessions/*

# Permissions du dossier cache
chmod 755 storage/framework/cache/
            </div>
            
            <h4>2. V√©rifier la Configuration :</h4>
            <div class="code-block">
# V√©rifier la cl√© d'application
php artisan tinker
config('app.key'); // Ne doit pas √™tre vide

# V√©rifier la configuration des sessions
config('session.driver');
config('session.lifetime');
            </div>
            
            <h4>3. Mode Debug :</h4>
            <div class="code-block">
# Dans .env
APP_DEBUG=true

# Puis v√©rifier les logs d√©taill√©s
tail -f storage/logs/laravel.log
            </div>
        </div>
        
        <div class="test-section">
            <h2>üéØ Actions de Test</h2>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="/test-csrf" class="btn btn-primary" target="_blank">
                    üß™ Tester CSRF
                </a>
                <a href="/activites" class="btn btn-success" target="_blank">
                    üìã Tester Formulaire
                </a>
                <a href="javascript:location.reload()" class="btn btn-warning">
                    üîÑ Actualiser Page
                </a>
                <a href="javascript:localStorage.clear();sessionStorage.clear();location.reload()" class="btn btn-danger">
                    üóëÔ∏è Vider Cache
                </a>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üéâ R√©solution</h2>
            <p class="success">L'erreur 419 devrait maintenant √™tre r√©solue !</p>
            
            <h3>Am√©liorations Apport√©es :</h3>
            <ul>
                <li>‚úÖ <strong>Dur√©e de session augment√©e :</strong> 8 heures au lieu de 2</li>
                <li>‚úÖ <strong>Route de diagnostic :</strong> /test-csrf pour v√©rifier</li>
                <li>‚úÖ <strong>Tokens CSRF v√©rifi√©s :</strong> Pr√©sents dans tous les formulaires</li>
                <li>‚úÖ <strong>Guide de r√©solution :</strong> Solutions √©tape par √©tape</li>
            </ul>
            
            <h3>En Cas de R√©cidive :</h3>
            <ol>
                <li><strong>Actualisez la page</strong> (F5)</li>
                <li><strong>Videz le cache</strong> (Ctrl+Shift+Delete)</li>
                <li><strong>Reconnectez-vous</strong> si n√©cessaire</li>
                <li><strong>V√©rifiez /test-csrf</strong> pour diagnostiquer</li>
            </ol>
            
            <p><strong>Vous devriez maintenant pouvoir utiliser l'application sans erreur 419 !</strong></p>
        </div>
    </div>
</body>
</html>
